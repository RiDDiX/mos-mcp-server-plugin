name: Build Debian Package

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [amd64, arm64]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Install dependencies
        run: |
          cd staticfiles
          npm install --production

      - name: Create package structure
        run: |
          PKG_NAME="mos-mcp-server"
          VERSION="${{ steps.version.outputs.version }}"
          ARCH="${{ matrix.arch }}"
          PKG_DIR="${PKG_NAME}_${VERSION}_${ARCH}"
          
          # Create directory structure
          mkdir -p "${PKG_DIR}/DEBIAN"
          mkdir -p "${PKG_DIR}/opt/mos-mcp-server/src/tools"
          mkdir -p "${PKG_DIR}/etc/init.d"
          
          # Copy application files
          cp -r staticfiles/src/* "${PKG_DIR}/opt/mos-mcp-server/src/"
          cp staticfiles/package.json "${PKG_DIR}/opt/mos-mcp-server/"
          cp -r staticfiles/node_modules "${PKG_DIR}/opt/mos-mcp-server/" 2>/dev/null || true
          
          # Create control file
          cat > "${PKG_DIR}/DEBIAN/control" << EOF
          Package: ${PKG_NAME}
          Version: ${VERSION}
          Section: utils
          Priority: optional
          Architecture: ${ARCH}
          Depends: nodejs (>= 18.0.0)
          Maintainer: RiDDiX
          Description: MOS MCP Server Plugin
           Model Context Protocol server for AI assistant integration with MOS.
           Provides 70+ tools covering all MOS API functionality.
          EOF
          
          # Create init.d script
          cat > "${PKG_DIR}/etc/init.d/mos-mcp-server" << 'INITEOF'
          #!/bin/sh
          ### BEGIN INIT INFO
          # Provides:          mos-mcp-server
          # Required-Start:    $local_fs $network
          # Required-Stop:     $local_fs $network
          # Default-Start:     2 3 4 5
          # Default-Stop:      0 1 6
          # Short-Description: MOS MCP Server
          # Description:       Model Context Protocol server for MOS
          ### END INIT INFO
          
          NAME="mos-mcp-server"
          DAEMON="/usr/bin/node"
          DAEMON_ARGS="/opt/mos-mcp-server/src/index.js"
          PIDFILE="/var/run/${NAME}.pid"
          LOGFILE="/var/log/${NAME}.log"
          
          export NODE_ENV=production
          export MOS_API_URL=http://127.0.0.1:3000
          
          start() {
              echo "Starting $NAME..."
              if [ -f "$PIDFILE" ] && kill -0 $(cat "$PIDFILE") 2>/dev/null; then
                  echo "$NAME is already running"
                  return 1
              fi
              $DAEMON $DAEMON_ARGS >> "$LOGFILE" 2>&1 &
              echo $! > "$PIDFILE"
              echo "$NAME started"
          }
          
          stop() {
              echo "Stopping $NAME..."
              if [ ! -f "$PIDFILE" ]; then
                  echo "$NAME is not running"
                  return 1
              fi
              kill $(cat "$PIDFILE") 2>/dev/null
              rm -f "$PIDFILE"
              echo "$NAME stopped"
          }
          
          status() {
              if [ -f "$PIDFILE" ] && kill -0 $(cat "$PIDFILE") 2>/dev/null; then
                  echo "$NAME is running (PID: $(cat $PIDFILE))"
              else
                  echo "$NAME is not running"
              fi
          }
          
          case "$1" in
              start)   start ;;
              stop)    stop ;;
              restart) stop; start ;;
              status)  status ;;
              *)       echo "Usage: $0 {start|stop|restart|status}"; exit 1 ;;
          esac
          INITEOF
          
          chmod 755 "${PKG_DIR}/etc/init.d/mos-mcp-server"
          
          # Create postinst script
          cat > "${PKG_DIR}/DEBIAN/postinst" << 'EOF'
          #!/bin/sh
          set -e
          update-rc.d mos-mcp-server defaults 2>/dev/null || true
          /etc/init.d/mos-mcp-server start 2>/dev/null || true
          EOF
          chmod 755 "${PKG_DIR}/DEBIAN/postinst"
          
          # Create prerm script
          cat > "${PKG_DIR}/DEBIAN/prerm" << 'EOF'
          #!/bin/sh
          set -e
          /etc/init.d/mos-mcp-server stop 2>/dev/null || true
          update-rc.d -f mos-mcp-server remove 2>/dev/null || true
          EOF
          chmod 755 "${PKG_DIR}/DEBIAN/prerm"

      - name: Build .deb package
        run: |
          PKG_NAME="mos-mcp-server"
          VERSION="${{ steps.version.outputs.version }}"
          ARCH="${{ matrix.arch }}"
          PKG_DIR="${PKG_NAME}_${VERSION}_${ARCH}"
          
          dpkg-deb --build "${PKG_DIR}"
          
          # Create MD5 checksum
          md5sum "${PKG_DIR}.deb" > "${PKG_DIR}.deb.md5"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mos-mcp-server-${{ matrix.arch }}
          path: |
            *.deb
            *.md5

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/*.deb
            artifacts/*.md5
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
